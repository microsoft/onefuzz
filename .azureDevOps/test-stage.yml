parameters:
- name: 'testTarget'
  type: string


steps:
- template: common-steps.yml
- task: PythonScript@0
  displayName: 'download'
  inputs:
    scriptSource: 'filePath'
    scriptPath: '$(Build.SourcesDirectory)/src/utils/check-pr/github_client.py'
    arguments: --pr ${{ parameters.pr }} --destination $(Build.SourcesDirectory)/checkpr
  env:
    GITHUB_ISSUE_TOKEN: $(GITHUB_ISSUE_TOKEN)

- pwsh: |
    # Write your PowerShell commands here.
    cd $(Build.SourcesDirectory)/checkpr/
    Expand-Archive -Path release-artifacts.zip -DestinationPath integration
    Expand-Archive -Path onefuzz-deployment*.zip -DestinationPath .
  name: 'expand'

- pwsh: |
    python -m venv .env
    . ./.env/bin/Activate.ps1
    cd $(Build.SourcesDirectory)/checkpr
    pip install install -q wheel
    pip install -q -r requirements.txt
    pip install sdk/onefuzztypes-*.whl
    pip install sdk/onefuzz-*.whl
    cd integration
    python integration-test.py test . --region $(testRegion) --endpoint $(endpoint) --client_id $(client_id) --client_secret $(client_secret) --targets $(testTarget)
  displayName: 'test ${{ parameters.testTarget }}'