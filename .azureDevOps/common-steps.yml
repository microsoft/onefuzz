parameters:
- name: pr
  type: string

- name: skip_update
  type: boolean

steps:
  - task: UsePythonVersion@0
    displayName: 'Use Python 3.8'
    inputs:
      versionSpec: '3.8'

  - script: python -m pip install --upgrade pip setuptools wheel
    displayName: 'Install tools'

  - script: pip install -r $(Build.SourcesDirectory)/src/utils/check-pr/requirements.txt
    displayName: 'Install Requirements'

  - script: wget -q https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb && sudo dpkg -i packages-microsoft-prod.deb
    displayName: 'Install function tools'

  - script: sudo apt-get update && sudo apt-get install azure-functions-core-tools-3
    displayName: apt-get update

  - script: sudo apt-get install gdb
    displayName: install gdb

  - script: az login -u 1f-test-runner@microsoft.com -p $(1f-test-runner)
    displayName: Login

  - task: PythonScript@0
    displayName: 'download'
    inputs:
      scriptSource: 'filePath'
      scriptPath: '$(Build.SourcesDirectory)/src/utils/check-pr/github_client.py'
      arguments: --pr ${{ parameters.pr }} --destination $(Build.SourcesDirectory)/checkpr ${{parameters.skip_update}}
    env:
      GITHUB_ISSUE_TOKEN: $(GITHUB_ISSUE_TOKEN)

  - pwsh: |
      # Write your PowerShell commands here.
      cd $(Build.SourcesDirectory)/checkpr/
      Expand-Archive -Path release-artifacts.zip -DestinationPath .
      Expand-Archive -Path onefuzz-deployment*.zip -DestinationPath .
      Expand-Archive -Path integration-test-artifacts.zip -DestinationPath integration
    name: 'expand'

